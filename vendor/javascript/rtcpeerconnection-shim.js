import e from"sdp";var t={};var r=e;function writeMediaSection(e,t,n,a,i){var s=r.writeRtpDescription(e.kind,t);s+=r.writeIceParameters(e.iceGatherer.getLocalParameters());s+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":i||"active");s+="a=mid:"+e.mid+"\r\n";e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n";if(e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var c="msid:"+(a?a.id:"-")+" "+o+"\r\n";s+="a="+c;s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c;if(e.sendEncodingParameters[0].rtx){s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c;s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n";e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n");return s}function filterIceServers(e,t){var r=false;e=JSON.parse(JSON.stringify(e));return e.filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var a="string"===typeof n;a&&(n=[n]);n=n.filter((function(e){var n=0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!r;if(n){r=true;return true}return 0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")}));delete e.url;e.urls=a?n[0]:n;return!!n.length}}))}function getCommonCapabilities(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]};var findCodecByPayloadType=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]};var rtxCapabilityMatches=function(e,t,r,n){var a=findCodecByPayloadType(e.parameters.apt,r);var i=findCodecByPayloadType(t.parameters.apt,n);return a&&i&&a.name.toLowerCase()===i.name.toLowerCase()};e.codecs.forEach((function(n){for(var a=0;a<t.codecs.length;a++){var i=t.codecs[a];if(n.name.toLowerCase()===i.name.toLowerCase()&&n.clockRate===i.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&i.parameters.apt&&!rtxCapabilityMatches(n,i,e.codecs,t.codecs))continue;i=JSON.parse(JSON.stringify(i));i.numChannels=Math.min(n.numChannels,i.numChannels);r.codecs.push(i);i.rtcpFeedback=i.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return true;return false}));break}}}));e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var a=t.headerExtensions[n];if(e.uri===a.uri){r.headerExtensions.push(a);break}}}));return r}function isActionAllowedInSignalingState(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function maybeAddCandidate(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));r||e.addRemoteCandidate(t);return!r}function makeError(e,t){var r=new Error(t);r.name=e;return r}t=function(e,t){function addTrackToStreamAndFireEvent(t,r){r.addTrack(t);r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function removeTrackFromStreamAndFireEvent(t,r){r.removeTrack(t);r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}function fireAddTrack(t,r,n,a){var i=new Event("track");i.track=r;i.receiver=n;i.transceiver={receiver:n};i.streams=a;e.setTimeout((function(){t._dispatchEvent("track",i)}))}var RTCPeerConnection=function(n){var a=this;var i=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){a[e]=i[e].bind(i)}));this.canTrickleIceCandidates=null;this.needNegotiation=false;this.localStreams=[];this.remoteStreams=[];this.localDescription=null;this.remoteDescription=null;this.signalingState="stable";this.iceConnectionState="new";this.iceGatheringState="new";n=JSON.parse(JSON.stringify(n||{}));this.usingBundle="max-bundle"===n.bundlePolicy;if("negotiate"===n.rtcpMuxPolicy)throw makeError("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require");switch(n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all";break}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced";break}n.iceServers=filterIceServers(n.iceServers||[],t);this._iceGatherers=[];if(n.iceCandidatePoolSize)for(var s=n.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n;this.transceivers=[];this._sdpSessionId=r.generateSessionId();this._sdpSessionVersion=0;this._dtlsRole=void 0;this._isClosed=false};RTCPeerConnection.prototype.onicecandidate=null;RTCPeerConnection.prototype.onaddstream=null;RTCPeerConnection.prototype.ontrack=null;RTCPeerConnection.prototype.onremovestream=null;RTCPeerConnection.prototype.onsignalingstatechange=null;RTCPeerConnection.prototype.oniceconnectionstatechange=null;RTCPeerConnection.prototype.onicegatheringstatechange=null;RTCPeerConnection.prototype.onnegotiationneeded=null;RTCPeerConnection.prototype.ondatachannel=null;RTCPeerConnection.prototype._dispatchEvent=function(e,t){if(!this._isClosed){this.dispatchEvent(t);"function"===typeof this["on"+e]&&this["on"+e](t)}};RTCPeerConnection.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)};RTCPeerConnection.prototype.getConfiguration=function(){return this._config};RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams};RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams};RTCPeerConnection.prototype._createTransceiver=function(e){var t=this.transceivers.length>0;var r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:true};if(this.usingBundle&&t){r.iceTransport=this.transceivers[0].iceTransport;r.dtlsTransport=this.transceivers[0].dtlsTransport}else{var n=this._createIceAndDtlsTransports();r.iceTransport=n.iceTransport;r.dtlsTransport=n.dtlsTransport}this.transceivers.push(r);return r};RTCPeerConnection.prototype.addTrack=function(t,r){if(this._isClosed)throw makeError("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n=this.transceivers.find((function(e){return e.track===t}));if(n)throw makeError("InvalidAccessError","Track already exists.");var a;for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(a=this.transceivers[i]);a||(a=this._createTransceiver(t.kind));this._maybeFireNegotiationNeeded();-1===this.localStreams.indexOf(r)&&this.localStreams.push(r);a.track=t;a.stream=r;a.rtpSender=new e.RTCRtpSender(t,a.dtlsTransport);return a.rtpSender};RTCPeerConnection.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e)}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled}))}));n.getTracks().forEach((function(e){r.addTrack(e,n)}))}};RTCPeerConnection.prototype.removeTrack=function(t){if(this._isClosed)throw makeError("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw makeError("InvalidAccessError","Sender was not created by this connection.");var n=r.stream;r.rtpSender.stop();r.rtpSender=null;r.track=null;r.stream=null;var a=this.transceivers.map((function(e){return e.stream}));-1===a.indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1);this._maybeFireNegotiationNeeded()};RTCPeerConnection.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r)}))};RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))};RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))};RTCPeerConnection.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var a=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});Object.defineProperty(a,"state",{value:"new",writable:true});this.transceivers[t].bufferedCandidateEvents=[];this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;a.state=r?"completed":"gathering";null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)};a.addEventListener("localcandidate",this.transceivers[t].bufferCandidates);return a};RTCPeerConnection.prototype._gather=function(t,n){var a=this;var i=this.transceivers[n].iceGatherer;if(!i.onlocalcandidate){var s=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null;i.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates);i.onlocalcandidate=function(e){if(!(a.usingBundle&&n>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:n};var o=e.candidate;var c=!o||0===Object.keys(o).length;if(c)"new"!==i.state&&"gathering"!==i.state||(i.state="completed");else{"new"===i.state&&(i.state="gathering");o.component=1;var d=r.writeCandidate(o);s.candidate=Object.assign(s.candidate,r.parseCandidate(d));s.candidate.candidate=d}var p=r.getMediaSections(a.localDescription.sdp);p[s.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n";a.localDescription.sdp=r.getDescription(a.localDescription.sdp)+p.join("");var l=a.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));if("gathering"!==a.iceGatheringState){a.iceGatheringState="gathering";a._emitGatheringStateChange()}c||a._dispatchEvent("icecandidate",s);if(l){a._dispatchEvent("icecandidate",new Event("icecandidate"));a.iceGatheringState="complete";a._emitGatheringStateChange()}}};e.setTimeout((function(){s.forEach((function(e){i.onlocalcandidate(e)}))}),0)}};RTCPeerConnection.prototype._createIceAndDtlsTransports=function(){var t=this;var r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateConnectionState()};var n=new e.RTCDtlsTransport(r);n.ondtlsstatechange=function(){t._updateConnectionState()};n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:true});t._updateConnectionState()};return{iceTransport:r,dtlsTransport:n}};RTCPeerConnection.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;if(t){delete t.onlocalcandidate;delete this.transceivers[e].iceGatherer}var r=this.transceivers[e].iceTransport;if(r){delete r.onicestatechange;delete this.transceivers[e].iceTransport}var n=this.transceivers[e].dtlsTransport;if(n){delete n.ondtlsstatechange;delete n.onerror;delete this.transceivers[e].dtlsTransport}};RTCPeerConnection.prototype._transceive=function(e,n,a){var i=getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);if(n&&e.rtpSender){i.encodings=e.sendEncodingParameters;i.rtcp={cname:r.localCName,compound:e.rtcpParameters.compound};e.recvEncodingParameters.length&&(i.rtcp.ssrc=e.recvEncodingParameters[0].ssrc);e.rtpSender.send(i)}if(a&&e.rtpReceiver&&i.codecs.length>0){"video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx}));e.recvEncodingParameters.length?i.encodings=e.recvEncodingParameters:i.encodings=[{}];i.rtcp={compound:e.rtcpParameters.compound};e.rtcpParameters.cname&&(i.rtcp.cname=e.rtcpParameters.cname);e.sendEncodingParameters.length&&(i.rtcp.ssrc=e.sendEncodingParameters[0].ssrc);e.rtpReceiver.receive(i)}};RTCPeerConnection.prototype.setLocalDescription=function(e){var t=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(makeError("TypeError",'Unsupported type "'+e.type+'"'));if(!isActionAllowedInSignalingState("setLocalDescription",e.type,t.signalingState)||t._isClosed)return Promise.reject(makeError("InvalidStateError","Can not set local "+e.type+" in state "+t.signalingState));var n;var a;if("offer"===e.type){n=r.splitSections(e.sdp);a=n.shift();n.forEach((function(e,n){var a=r.parseRtpParameters(e);t.transceivers[n].localCapabilities=a}));t.transceivers.forEach((function(e,r){t._gather(e.mid,r)}))}else if("answer"===e.type){n=r.splitSections(t.remoteDescription.sdp);a=n.shift();var i=r.matchPrefix(a,"a=ice-lite").length>0;n.forEach((function(e,n){var s=t.transceivers[n];var o=s.iceGatherer;var c=s.iceTransport;var d=s.dtlsTransport;var p=s.localCapabilities;var l=s.remoteCapabilities;var f=r.isRejected(e)&&0===r.matchPrefix(e,"a=bundle-only").length;if(!f&&!s.isDatachannel){var v=r.getIceParameters(e,a);var u=r.getDtlsParameters(e,a);i&&(u.role="server");if(!t.usingBundle||0===n){t._gather(s.mid,n);"new"===c.state&&c.start(o,v,i?"controlling":"controlled");"new"===d.state&&d.start(u)}var m=getCommonCapabilities(p,l);t._transceive(s,m.codecs.length>0,false)}}))}t.localDescription={type:e.type,sdp:e.sdp};"offer"===e.type?t._updateSignalingState("have-local-offer"):t._updateSignalingState("stable");return Promise.resolve()};RTCPeerConnection.prototype.setRemoteDescription=function(n){var a=this;if(-1===["offer","answer"].indexOf(n.type))return Promise.reject(makeError("TypeError",'Unsupported type "'+n.type+'"'));if(!isActionAllowedInSignalingState("setRemoteDescription",n.type,a.signalingState)||a._isClosed)return Promise.reject(makeError("InvalidStateError","Can not set remote "+n.type+" in state "+a.signalingState));var i={};a.remoteStreams.forEach((function(e){i[e.id]=e}));var s=[];var o=r.splitSections(n.sdp);var c=o.shift();var d=r.matchPrefix(c,"a=ice-lite").length>0;var p=r.matchPrefix(c,"a=group:BUNDLE ").length>0;a.usingBundle=p;var l=r.matchPrefix(c,"a=ice-options:")[0];a.canTrickleIceCandidates=!!l&&l.substr(14).split(" ").indexOf("trickle")>=0;o.forEach((function(o,l){var f=r.splitLines(o);var v=r.getKind(o);var u=r.isRejected(o)&&0===r.matchPrefix(o,"a=bundle-only").length;var m=f[0].substr(2).split(" ")[2];var h=r.getDirection(o,c);var g=r.parseMsid(o);var y=r.getMid(o)||r.generateIdentifier();if("application"!==v||"DTLS/SCTP"!==m){var E;var S;var T;var C;var k;var w;var P;var b;var R;var _=r.parseRtpParameters(o);var x;var I;if(!u){x=r.getIceParameters(o,c);I=r.getDtlsParameters(o,c);I.role="client"}P=r.parseRtpEncodingParameters(o);var D=r.parseRtcpParameters(o);var G=r.matchPrefix(o,"a=end-of-candidates",c).length>0;var A=r.matchPrefix(o,"a=candidate:").map((function(e){return r.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===n.type||"answer"===n.type)&&!u&&p&&l>0&&a.transceivers[l]){a._disposeIceAndDtlsTransports(l);a.transceivers[l].iceGatherer=a.transceivers[0].iceGatherer;a.transceivers[l].iceTransport=a.transceivers[0].iceTransport;a.transceivers[l].dtlsTransport=a.transceivers[0].dtlsTransport;a.transceivers[l].rtpSender&&a.transceivers[l].rtpSender.setTransport(a.transceivers[0].dtlsTransport);a.transceivers[l].rtpReceiver&&a.transceivers[l].rtpReceiver.setTransport(a.transceivers[0].dtlsTransport)}if("offer"!==n.type||u){if("answer"===n.type&&!u){E=a.transceivers[l];S=E.iceGatherer;T=E.iceTransport;C=E.dtlsTransport;k=E.rtpReceiver;w=E.sendEncodingParameters;b=E.localCapabilities;a.transceivers[l].recvEncodingParameters=P;a.transceivers[l].remoteCapabilities=_;a.transceivers[l].rtcpParameters=D;A.length&&"new"===T.state&&(!d&&!G||p&&0!==l?A.forEach((function(e){maybeAddCandidate(E.iceTransport,e)})):T.setRemoteCandidates(A));if(!p||0===l){"new"===T.state&&T.start(S,x,"controlling");"new"===C.state&&C.start(I)}a._transceive(E,"sendrecv"===h||"recvonly"===h,"sendrecv"===h||"sendonly"===h);if(!k||"sendrecv"!==h&&"sendonly"!==h)delete E.rtpReceiver;else{R=k.track;if(g){i[g.stream]||(i[g.stream]=new e.MediaStream);addTrackToStreamAndFireEvent(R,i[g.stream]);s.push([R,k,i[g.stream]])}else{i.default||(i.default=new e.MediaStream);addTrackToStreamAndFireEvent(R,i.default);s.push([R,k,i.default])}}}}else{E=a.transceivers[l]||a._createTransceiver(v);E.mid=y;E.iceGatherer||(E.iceGatherer=a._createIceGatherer(l,p));A.length&&"new"===E.iceTransport.state&&(!G||p&&0!==l?A.forEach((function(e){maybeAddCandidate(E.iceTransport,e)})):E.iceTransport.setRemoteCandidates(A));b=e.RTCRtpReceiver.getCapabilities(v);t<15019&&(b.codecs=b.codecs.filter((function(e){return"rtx"!==e.name})));w=E.sendEncodingParameters||[{ssrc:1001*(2*l+2)}];var M=false;if("sendrecv"===h||"sendonly"===h){M=!E.rtpReceiver;k=E.rtpReceiver||new e.RTCRtpReceiver(E.dtlsTransport,v);if(M){var O;R=k.track;if(g&&"-"===g.stream);else if(g){if(!i[g.stream]){i[g.stream]=new e.MediaStream;Object.defineProperty(i[g.stream],"id",{get:function(){return g.stream}})}Object.defineProperty(R,"id",{get:function(){return g.track}});O=i[g.stream]}else{i.default||(i.default=new e.MediaStream);O=i.default}if(O){addTrackToStreamAndFireEvent(R,O);E.associatedRemoteMediaStreams.push(O)}s.push([R,k,O])}}else if(E.rtpReceiver&&E.rtpReceiver.track){E.associatedRemoteMediaStreams.forEach((function(e){var t=e.getTracks().find((function(e){return e.id===E.rtpReceiver.track.id}));t&&removeTrackFromStreamAndFireEvent(t,e)}));E.associatedRemoteMediaStreams=[]}E.localCapabilities=b;E.remoteCapabilities=_;E.rtpReceiver=k;E.rtcpParameters=D;E.sendEncodingParameters=w;E.recvEncodingParameters=P;a._transceive(a.transceivers[l],false,M)}}else a.transceivers[l]={mid:y,isDatachannel:true}}));void 0===a._dtlsRole&&(a._dtlsRole="offer"===n.type?"active":"passive");a.remoteDescription={type:n.type,sdp:n.sdp};"offer"===n.type?a._updateSignalingState("have-remote-offer"):a._updateSignalingState("stable");Object.keys(i).forEach((function(t){var r=i[t];if(r.getTracks().length){if(-1===a.remoteStreams.indexOf(r)){a.remoteStreams.push(r);var n=new Event("addstream");n.stream=r;e.setTimeout((function(){a._dispatchEvent("addstream",n)}))}s.forEach((function(e){var t=e[0];var n=e[1];r.id===e[2].id&&fireAddTrack(a,t,n,[r])}))}}));s.forEach((function(e){e[2]||fireAddTrack(a,e[0],e[1],[])}));e.setTimeout((function(){a&&a.transceivers&&a.transceivers.forEach((function(e){if(e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0){console.warn("Timeout for addRemoteCandidate. Consider sending "+"an end-of-candidates notification");e.iceTransport.addRemoteCandidate({})}}))}),4e3);return Promise.resolve()};RTCPeerConnection.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop();e.dtlsTransport&&e.dtlsTransport.stop();e.rtpSender&&e.rtpSender.stop();e.rtpReceiver&&e.rtpReceiver.stop()}));this._isClosed=true;this._updateSignalingState("closed")};RTCPeerConnection.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)};RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var t=this;if("stable"===this.signalingState&&true!==this.needNegotiation){this.needNegotiation=true;e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=false;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0)}};RTCPeerConnection.prototype._updateConnectionState=function(){var e;var t={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach((function(e){t[e.iceTransport.state]++;t[e.dtlsTransport.state]++}));t.connected+=t.completed;e="new";t.failed>0?e="failed":t.connecting>0||t.checking>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":(t.connected>0||t.completed>0)&&(e="connected");if(e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}};RTCPeerConnection.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(makeError("InvalidStateError","Can not call createOffer after close"));var a=n.transceivers.filter((function(e){return"audio"===e.kind})).length;var i=n.transceivers.filter((function(e){return"video"===e.kind})).length;var s=arguments[0];if(s){if(s.mandatory||s.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==s.offerToReceiveAudio&&(a=true===s.offerToReceiveAudio?1:false===s.offerToReceiveAudio?0:s.offerToReceiveAudio);void 0!==s.offerToReceiveVideo&&(i=true===s.offerToReceiveVideo?1:false===s.offerToReceiveVideo?0:s.offerToReceiveVideo)}n.transceivers.forEach((function(e){if("audio"===e.kind){a--;a<0&&(e.wantReceive=false)}else if("video"===e.kind){i--;i<0&&(e.wantReceive=false)}}));while(a>0||i>0){if(a>0){n._createTransceiver("audio");a--}if(i>0){n._createTransceiver("video");i--}}var o=r.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.transceivers.forEach((function(a,i){var s=a.track;var o=a.kind;var c=a.mid||r.generateIdentifier();a.mid=c;a.iceGatherer||(a.iceGatherer=n._createIceGatherer(i,n.usingBundle));var d=e.RTCRtpSender.getCapabilities(o);t<15019&&(d.codecs=d.codecs.filter((function(e){return"rtx"!==e.name})));d.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1");a.remoteCapabilities&&a.remoteCapabilities.codecs&&a.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))}));d.headerExtensions.forEach((function(e){var t=a.remoteCapabilities&&a.remoteCapabilities.headerExtensions||[];t.forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var p=a.sendEncodingParameters||[{ssrc:1001*(2*i+1)}];s&&t>=15019&&"video"===o&&!p[0].rtx&&(p[0].rtx={ssrc:p[0].ssrc+1});a.wantReceive&&(a.rtpReceiver=new e.RTCRtpReceiver(a.dtlsTransport,o));a.localCapabilities=d;a.sendEncodingParameters=p}));"max-compat"!==n._config.bundlePolicy&&(o+="a=group:BUNDLE "+n.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n");o+="a=ice-options:trickle\r\n";n.transceivers.forEach((function(e,t){o+=writeMediaSection(e,e.localCapabilities,"offer",e.stream,n._dtlsRole);o+="a=rtcp-rsize\r\n";if(e.iceGatherer&&"new"!==n.iceGatheringState&&(0===t||!n.usingBundle)){e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1;o+="a="+r.writeCandidate(e)+"\r\n"}));"completed"===e.iceGatherer.state&&(o+="a=end-of-candidates\r\n")}}));var c=new e.RTCSessionDescription({type:"offer",sdp:o});return Promise.resolve(c)};RTCPeerConnection.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(makeError("InvalidStateError","Can not call createAnswer after close"));var a=r.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(a+="a=group:BUNDLE "+n.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n");var i=r.getMediaSections(n.remoteDescription.sdp).length;n.transceivers.forEach((function(e,r){if(!(r+1>i))if(e.isDatachannel)a+="m=application 0 DTLS/SCTP 5000\r\n"+"c=IN IP4 0.0.0.0\r\n"+"a=mid:"+e.mid+"\r\n";else{if(e.stream){var s;"audio"===e.kind?s=e.stream.getAudioTracks()[0]:"video"===e.kind&&(s=e.stream.getVideoTracks()[0]);s&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1})}var o=getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);var c=o.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length;!c&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx;a+=writeMediaSection(e,o,"answer",e.stream,n._dtlsRole);e.rtcpParameters&&e.rtcpParameters.reducedSize&&(a+="a=rtcp-rsize\r\n")}}));var s=new e.RTCSessionDescription({type:"answer",sdp:a});return Promise.resolve(s)};RTCPeerConnection.prototype.addIceCandidate=function(e){var t=this;var n;return e&&!(void 0!==e.sdpMLineIndex||e.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(a,i){if(!t.remoteDescription)return i(makeError("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var o=0;o<t.transceivers.length;o++)if(t.transceivers[o].mid===e.sdpMid){s=o;break}var c=t.transceivers[s];if(!c)return i(makeError("OperationError","Can not add ICE candidate"));if(c.isDatachannel)return a();var d=Object.keys(e.candidate).length>0?r.parseCandidate(e.candidate):{};if("tcp"===d.protocol&&(0===d.port||9===d.port))return a();if(d.component&&1!==d.component)return a();if((0===s||s>0&&c.iceTransport!==t.transceivers[0].iceTransport)&&!maybeAddCandidate(c.iceTransport,d))return i(makeError("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();0===p.indexOf("a=")&&(p=p.substr(2));n=r.getMediaSections(t.remoteDescription.sdp);n[s]+="a="+(d.type?p:"end-of-candidates")+"\r\n";t.remoteDescription.sdp=n.join("")}else for(var l=0;l<t.transceivers.length;l++)if(!t.transceivers[l].isDatachannel){t.transceivers[l].iceTransport.addRemoteCandidate({});n=r.getMediaSections(t.remoteDescription.sdp);n[l]+="a=end-of-candidates\r\n";t.remoteDescription.sdp=r.getDescription(t.remoteDescription.sdp)+n.join("");if(t.usingBundle)break}a()}))};RTCPeerConnection.prototype.getStats=function(){var e=[];this.transceivers.forEach((function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(r){t[r]&&e.push(t[r].getStats())}))}));var fixStatsType=function(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};return new Promise((function(t){var r=new Map;Promise.all(e).then((function(e){e.forEach((function(e){Object.keys(e).forEach((function(t){e[t].type=fixStatsType(e[t]);r.set(t,e[t])}))}));t(r)}))}))};var n=["createOffer","createAnswer"];n.forEach((function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=arguments;return"function"===typeof e[0]||"function"===typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"===typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"===typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}}));n=["setLocalDescription","setRemoteDescription","addIceCandidate"];n.forEach((function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=arguments;return"function"===typeof e[1]||"function"===typeof e[2]?t.apply(this,arguments).then((function(){"function"===typeof e[1]&&e[1].apply(null)}),(function(t){"function"===typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}}));["getStats"].forEach((function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){var e=arguments;return"function"===typeof e[1]?t.apply(this,arguments).then((function(){"function"===typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}}));return RTCPeerConnection};var n=t;export default n;

